---
title: "obAnalytics Guide"
author: "[Phil Nocturne](http://parasec.net)"
date: "`r Sys.Date()`"
output: 
#  rmarkdown::html_vignette:
  html_document:
    theme: journal 
    toc: true
    highlight: espresso 
  pdf_document:
    toc: true
    highlight: espresso
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Microstructure2 Guide}
  \usepackage[utf8]{inputenc}
---

```{r, include=FALSE}
options(digits.secs=3)
library(obAnalytics)
#knitr::opts_chunk$set(dpi=100, fig.width=8, fig.height=6, results="hide") 
knitr::opts_chunk$set(dpi=100, fig.width=10, fig.height=6, results="hide")
```

# Overview 

Overview to the package and this guide.


# Loading data

lala

## Expected format

lala

## Processing, saving and loading

lala

## Preprocessed example data

lala

### Trades

trades...
```{r}
trades.ex <- tail(lob.data$trades, 10)
trades.ex$volume <- round(trades.ex$volume*10^-8, 2)
print(trades.ex, row.names=F)
```

```{r example trades, echo=F, results="markup"}
trades.ex <- tail(lob.data$trades, 10)
trades.ex$volume <- trades.ex$volume*10^-8
knitr::kable(trades.ex, digits=2, row.names=F)
```



# Visualisation

lala

## Order book shape

The purpose of the cumulative volume graph is to quickly identify the shape of 
the limit order book for the given point in time. The "shape" is defined as the 
cumulative volume available at each price level, starting at the best bid/ask. 

Using this shape, it is possible to visually summarise order book imbalance and
market depth. 

```{r} 
# get a limit order book for a specific point in time, limited to +- 150bps
# above/below best bid/ask price.
lob <- orderBook(lob.data$events, 
    tp=as.POSIXct("2015-05-01 04:38:17.429", tz="UTC"), bps.range=150)

# visualise the order book liquidity.
plotCurrentDepth(lob, volume.scale=10^-8)
```

In the figure above, an order book has been reconstructed with the _orderBook_
function for a specific point in time. The visualisation produced with the
_plotCurrentDepth_ function depicts a number of order book features. Firstly,
the embedded bar chart at the bottom of the plot shows the amount of volume 
available at specific price levels ranging from the _bid_ side on the left 
(blue) through to the _ask_ side (red) on the right. Secondly, the blue and red
lines show the _cumulative_ volume of the bar chart for the bid and ask sides of
the order book respectively. Finally, the two subtle vertical lines at price 
points \$234 and \$238 show the position of the top 1% largest limit orders.


## Price level volume

All lob.data:

```{r}
# plot all lob.data price level volume between $247 and $245 and overlay the 
# market midprice.
spread <- getSpread(lob.data$depth.summary)
plotPriceLevels(lob.data$depth, spread, price.from=227, price.to=245, 
    volume.scale=10^-8, col.bias=0.25, show.mp=T)
```


plot all depth levels, rescaling the volume by 10^-8.
produce 2 plots side-by-side: second plot contains depth levels with > 50 units of volume.

```{r}
spread <- with(lob.data, getSpread(depth.summary))
p1 <- with(lob.data, plotPriceLevels(depth, spread, col.bias=0.1, volume.scale=10^-8))
p2 <- with(lob.data, plotPriceLevels(depth, spread, col.bias=0.1, volume.scale=10^-8, volume.from=50))
library(grid)
pushViewport(viewport(layout=grid.layout(1, 2)))
print(p1, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(p2, vp=viewport(layout.pos.row=1, layout.pos.col=2))
```

with trades:

```{r}
# plot 1 hour of trades centred around the bid/ask spread. 
plotPriceLevels(lob.data$depth, trades=lob.data$trades, 
    price.from=236, price.to=237.75, volume.scale=10^-8, col.bias=0.2,
    start.time=as.POSIXct("2015-05-01 01:00:00.000", tz="UTC"),
    end.time=as.POSIXct("2015-05-01 02:00:00.000", tz="UTC"))
```

30 minute zoom:

```{r}
# zoom in to 30 minutes of bid/ask quotes.
spread <- getSpread(lob.data$depth.summary)
plotPriceLevels(lob.data$depth, spread, price.from=235.25, price.to=237,
    start.time=as.POSIXct("2015-05-01 00:45:00.000", tz="UTC"), 
    end.time=as.POSIXct("2015-05-01 01:15:00.000", tz="UTC"), 
    volume.scale=10^-8, col.bias=0.5, show.mp=F)
```

4 minute zoom:

```{r}
# zoom in to 4 minutes of bid/ask quotes.
spread <- getSpread(lob.data$depth.summary)
plotPriceLevels(lob.data$depth, spread, price.from=235.90, price.to=236.25,
    start.time=as.POSIXct("2015-05-01 00:55:00.000", tz="UTC"), 
    end.time=as.POSIXct("2015-05-01 00:59:00.000", tz="UTC"), 
    volume.scale=10^-8, col.bias=0.5, show.mp=F)
```

individual market paricipant:

```{r}
# 
spread <- getSpread(lob.data$depth.summary)
plotPriceLevels(lob.data$depth, spread, price.from=232.5, price.to=237.5,
    volume.scale=10^-8, col.bias=1, show.mp=T,
    end.time=as.POSIXct("2015-05-01 01:30:00.000", tz="UTC"),
    volume.from=8.59, volume.to=8.72)
```

```{r}
#
plotPriceLevels(lob.data$depth, price.from=235.65, price.to=237.65,
    volume.scale=10^-8, col.bias=1,
    start.time=as.POSIXct("2015-05-01 01:00:00.000", tz="UTC"),
    end.time=as.POSIXct("2015-05-01 03:00:00.000", tz="UTC"),
    volume.from=3.63, volume.to=3.83)
```

The available volume at each price level is colour coded according to the range of volume at all
price levels. The colour coding follows the visible spectrum, such that larger amounts of volume
appear "hotter" than smaller amounts, where cold = blue, hot = red.
Since the distribution of limit order size exponentially decays, it can be difficult to visually differentiate:
most values will appear to be blue. The function provides price, volume and a colour bias
range to overcome this.

## Liquidity

liquidity...

```{r}
plotVolumePercentiles(lob.data$depth.summary, volume.scale=10^-8, perc.line=F, start.time=as.POSIXct("2015-05-01 01:00:00.000", tz="UTC"),
    end.time=as.POSIXct("2015-05-01 04:00:00.000", tz="UTC"))
``` 

another...
```{r}
# visualise 15 minutes of order book liquidity.
# data will be aggregated to second-by-second resolution.
plotVolumePercentiles(lob.data$depth.summary,
start.time=as.POSIXct("2015-05-01 04:30:00.000", tz="UTC"),
end.time=as.POSIXct("2015-05-01 04:35:00.000", tz="UTC"),
volume.scale=10^-8)
```

## Fleeting orders

```{r}
plotVolumeMap(lob.data$events, volume.scale=10^-8, log.scale = T)
```

```{r}
plotVolumeMap(lob.data$events, volume.scale=10^-8, volume.from=3.5, volume.to=4)
```

```{r}
plotVolumeMap(lob.data$events, volume.scale=10^-8, volume.from=8.59, volume.to=8.72)
```

# Analysis

lala.

## Order book reconstruction

lala.

```{r}
tp <- as.POSIXct("2015-05-01 04:25:15.342", tz="UTC")
ob <- orderBook(lob.data$events, max.levels=10)
print(ob)
```

```{r example order book, echo=F, results="markup"}
tp <- as.POSIXct("2015-05-01 04:25:15.342", tz="UTC")
ob <- orderBook(lob.data$events, max.levels=10)
with(ob, {
  asks$liquidity <- asks$liquidity*10^-8
  bids$liquidity <- bids$liquidity*10^-8
  cols <- c("id", "timestamp", "liquidity", "price")
  knitr::kable(cbind(bids[, cols], asks[order(asks$liquidity), rev(cols)]), 
      row.names=F, align=c("r","r","r","r","l","l","l","l"), digits=2)
})
```

## Market impacts

### all impacts
lala.

```{r}
impacts <- tradeImpacts(lob.data$trades)
impacts <- impacts[impacts$dir == "sell", ]
bps <- 10000 * (impacts$max.price - impacts$min.price) / impacts$max.price
types <- with(lob.data, events[match(impacts$id, events$id), ]$type)
impacts <- cbind(impacts, type=types, bps)
head(impacts[order(-impacts$bps), ], 10)
```

```{r impacts example, echo=F, results="markup"}
impacts <- tradeImpacts(lob.data$trades)
impacts <- impacts[impacts$dir == "sell", ]
impacts <- impacts[, c("id", "max.price", "min.price", "vwap", "hits", "vol", 
    "end.time")]
impacts$vol <- impacts$vol*10^-8
bps <- 10000 * (impacts$max.price - impacts$min.price) / impacts$max.price
types <- with(lob.data, events[match(impacts$id, events$id), ]$type)
impacts <- cbind(impacts, type=types, bps)
knitr::kable(head(impacts[order(-impacts$bps), ], 10), row.names=F, digits=2)
```

### individual impact
lala.

```{r}
impact <- with(lob.data, trades[trades$taker == 65596324, 
    c("timestamp", "price", "volume", "maker")])
makers <- with(lob.data, events[match(impact$maker, events$id), ])
makers <- makers[makers$action == "created", 
    c("id", "timestamp", "aggressiveness.bps")]
impact <- cbind(impact, maker=makers[match(impact$maker, makers$id), 
    c("timestamp", "aggressiveness.bps")])
age <- impact$timestamp - impact$maker.timestamp
impact <-  cbind(impact[!is.na(age), c("timestamp", "price", "volume", 
    "maker.aggressiveness.bps")], age[!is.na(age)])
colnames(impact) <- c("timestamp", "price", "volume", "maker.agg", "age")
impact$volume <- impact$volume*10^-8
print(impact)
```

```{r impact example, echo=F, results="markup"}
impact <- with(lob.data, trades[trades$taker == 65596324,
    c("timestamp", "price", "volume", "maker")])
makers <- with(lob.data, events[match(impact$maker, events$id), ])
makers <- makers[makers$action == "created",
    c("id", "timestamp", "aggressiveness.bps")]
impact <- cbind(impact, maker=makers[match(impact$maker, makers$id),
    c("timestamp", "aggressiveness.bps")])
age <- impact$timestamp - impact$maker.timestamp
impact <-  cbind(impact[!is.na(age), c("timestamp", "price", "volume", 
    "maker.aggressiveness.bps")], age[!is.na(age)])
colnames(impact) <- c("timestamp", "price", "volume", "maker.agg", "age")
impact$volume <- impact$volume*10^-8
knitr::kable(impact, row.names=F, digits=2)
```



